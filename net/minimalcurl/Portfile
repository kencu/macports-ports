# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0

name                        minimalcurl
conflicts                   curl
version                     8.2.0
checksums                   rmd160  9ed42b1e75c9e4b5e03ed2f840972a86e2e99a84 \
                            sha256  2859ec79e2cd96e976a99493547359b8001af1d1e21f3a3a3b846544ef54500f \
                            size    2637208

categories                  net
platforms                   darwin
maintainers                 nomaintainer
license                     Curl

description                 a minimal curl used for macports-bootstrap
long_description            {*}${description}

homepage                    https://curl.se
master_sites                ${homepage}/download/:curl \
                            https://curl.askapache.com/:curl
distname                    curl-${version}
dist_subdir                 curl
use_xz                      yes
set curl_distfile           ${distfiles}
distfiles                   ${curl_distfile}:curl
checksums-prepend           ${curl_distfile}

PortGroup                   muniversal 1.0

revision                    0

#clear cxx_stdlib to allow default system compilers to be used
configure.cxx_stdlib

# Prevent curl-config from telling curl's dependents that they have to
# link with all of curl's dependencies as well.
patchfiles                  configure.patch

patchfiles-append           SCDynamicStoreCopyProxies.patch

configure.args              --disable-silent-rules \
                            --disable-manual \
                            --enable-ipv6 \
                            --without-gnutls \
                            --without-gssapi \
                            --without-libgsasl \
                            --without-librtmp \
                            --without-libssh2 \
                            --without-mbedtls \
                            --without-nghttp2 \
                            --without-nss \
                            --without-openssl \
                            --without-ssl \
                            --without-secure-transport \
                            --without-wolfssl \
                            --disable-ares \
                            --disable-ldap \
                            --disable-ldaps \
                            --without-brotli \
                            --without-libidn2 \
                            --without-zlib \
                            --without-zstd \
                            ac_cv_prog_AWK=/usr/bin/awk

configure.cflags-append     -mmacosx-version-min=${macosx_deployment_target}

configure.checks.implicit_function_declaration.whitelist-append strchr

configure.env               PKG_CONFIG_PATH=${prefix}

destroot.target install-exec

if {${os.platform} eq "darwin" && ${os.major} < 10 && [string match *macports-clang* ${configure.compiler}]} {
    depends_build-append    port:cctools
    configure.env-append    NM=${prefix}/bin/nm
    configure.args-append   lt_cv_path_NM=${prefix}/bin/nm
}

post-configure {
    if {[variant_exists universal] && [variant_isset universal]} {
        set dirs {}
        foreach arch ${universal_archs_to_use} {
            lappend dirs ${worksrcpath}-${arch}
        }
    } else {
        set dirs ${worksrcpath}
    }
    foreach dir ${dirs} {
        reinplace -E {s|-arch [a-z0-9_]+||g} ${dir}/curl-config
        # These flags only ends up in curl-config in some cases, such as
        # when "cross compiling" a universal binary.
        # See https://trac.macports.org/ticket/24001
        reinplace -E -q {s/ '(host_alias|--host)=[^']+'//g} ${dir}/curl-config
    }
}

test.run                    yes
test.target                 test-full

global merger_dont_diff
set merger_dont_diff "${prefix}/include/curl/curlbuild.h"

post-destroot {
    set docdir ${prefix}/share/doc/curl
    xinstall -d ${destroot}${docdir}/html/libcurl ${destroot}${docdir}/pdf/libcurl \
        ${destroot}${prefix}/share/aclocal
    xinstall -m 0644 -W ${worksrcpath} \
        CHANGES \
        COPYING \
        README \
        RELEASE-NOTES \
        ${destroot}${docdir}
    xinstall -m 0644 ${worksrcpath}/docs/libcurl/libcurl.m4 \
        ${destroot}${prefix}/share/aclocal/
}

variant wolfssl conflicts ssl description {Allow secure connections using wolfSSL (formerly CyaSSL)} {
    depends_lib-append      port:wolfssl \
                            path:share/curl/curl-ca-bundle.crt:curl-ca-bundle
    configure.args-delete   --without-ssl
    configure.args-replace  --without-wolfssl --with-wolfssl
    configure.args-append   --with-ca-bundle=${prefix}/share/curl/curl-ca-bundle.crt
}

variant ssl conflicts wolfssl description {Allow secure connections using OpenSSL} {
    depends_lib-append      path:lib/libssl.dylib:openssl \
                            path:share/curl/curl-ca-bundle.crt:curl-ca-bundle
    configure.args-delete   --without-ssl
    configure.args-replace  --without-openssl --with-openssl
    configure.args-append   --with-ca-bundle=${prefix}/share/curl/curl-ca-bundle.crt
}

if {![variant_isset wolfssl]} {
    default_variants-append +ssl
}

livecheck.type              regex
livecheck.url               [join [lrange [split [lindex ${master_sites} 0] {:}] 0 end-1] {:}]
livecheck.regex             curl-(\[0-9.\]+)[quotemeta ${extract.suffix}]
